name: 'GitHub Copilot CLI'
description: 'GitHub Copilot CLI wrapper'
inputs:
  github-token:
    description: 'GitHub Personal Access Token with required permissions'
    required: true
  prompt:
    description: 'Prompt to send to GitHub Copilot'
    required: true
  mcp-config:
    description: 'MCP configuration for GitHub Copilot'
    required: false
    default: |
      {
        "mcpServers": { }
      }
  copilot-config:
    description: 'Configuration for GitHub Copilot'
    required: false
    default: |
      {
        "banner": "never",
        "render_markdown": true,
        "screen_reader": false,
        "theme": "auto",
        "trusted_folders": [
          "/"
        ]
      }
  log-level:
    description: 'Log level for GitHub Copilot'
    required: false
    default: 'all'
  allow-all-tools:
    description: 'Allow all tools without approval (DANGEROUS - use with caution in untrusted environments)'
    required: false
    default: 'true'
  denied-tools:
    description: 'Comma-separated list of tools to deny (e.g., "shell(rm),shell(git push)")'
    required: false
    default: ''
  upload-artifact:
    description: 'Upload artifact after running Copilot'
    required: false
    default: true
runs:
  using: 'composite'
  steps:
    - uses: actions/setup-node@v4
      with:
        node-version: '22'
    - run: npm install -g @github/copilot
      shell: bash
    - run: |
        mkdir -p $XDG_CONFIG_HOME/.copilot

        echo '$MCP_CONFIG' > $XDG_CONFIG_HOME/.copilot/mcp-config.json
        cat $XDG_CONFIG_HOME/.copilot/mcp-config.json

        echo "$CONFIG" > $XDG_CONFIG_HOME/.copilot/config.json
        cat $XDG_CONFIG_HOME/.copilot/config.json
      shell: bash
      env:
        CONFIG: ${{ inputs.copilot-config }}
        MCP_CONFIG: ${{ inputs.mcp-config }}
    - run: |
        COPILOT_CMD="copilot"
        
        # Add tool permissions
        if [ "$ALLOW_ALL_TOOLS" = "true" ]; then
          COPILOT_CMD="$COPILOT_CMD --allow-all-tools"
        fi
        
        # Add denied tools
        if [ -n "$DENIED_TOOLS" ]; then
          IFS=',' read -ra TOOLS <<< "$DENIED_TOOLS"
          for tool in "${TOOLS[@]}"; do
            COPILOT_CMD="$COPILOT_CMD --deny-tool '$tool'"
          done
        fi
        
        # Add other options
        COPILOT_CMD="$COPILOT_CMD --log-level $LOG_LEVEL --log-dir ~/.copilot/logs --save-trajectory-output ~/.copilot/trajectory.md"
        
        # Execute with prompt piped to stdin and close stdin after
        echo "$PROMPT" | eval $COPILOT_CMD < /dev/null
      id: copilot
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        PROMPT: ${{ inputs.prompt }}
        LOG_LEVEL: ${{ inputs.log-level }}
        ALLOW_ALL_TOOLS: ${{ inputs.allow-all-tools }}
        DENIED_TOOLS: ${{ inputs.denied-tools }}
      shell: bash
    - uses: actions/upload-artifact@v4
      if: ${{ inputs.upload-artifact }}
      with:
        name: copilot-logs
        path: |
          ~/.copilot/logs/
          ~/.copilot/trajectory.md
          /home/runner/.config/
    # - name: Setup tmate session
    #   uses: mxschmitt/action-tmate@v3